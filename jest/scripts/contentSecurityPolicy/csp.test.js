/**
 * @jest-environment jsdom
 */
import ContentSecurityPolicy from '../../../acrobat/scripts/ContentSecurityPolicy/csp';

describe('Test ContentSecurityPolicy', () => {
  let hostnameGetter;
  let url;

  beforeEach(async () => {
    delete window.location;
  });

  afterEach(() => {
    document.getElementsByTagName('html')[0].innerHTML = '';
  });

  test('ContentSecurityPolicy for www.adobe.com', async () => {
    window.location = new URL('https://www.adobe.com/acrobat/online/test');
    await ContentSecurityPolicy();
    const meta = document.querySelector('head meta');
    expect(meta.hasAttribute('http-equiv')).toBe(true);
    expect(meta.hasAttribute('content')).toBe(true);
    expect(meta.getAttribute('http-equiv')).toBe('Content-Security-Policy');
    expect(meta.getAttribute('content')).toBe(
      "connect-src 'self' blob: 14257-chimera.adobeioruntime.net *.adobe.com *.clicktale.net/ *.adobe.io *.adobelogin.com *.amazonaws.com *.blob.core.windows.net *.mktoresp.com accounts.google.com/gsi/log accounts.google.com/gsi/status acom-reviews--adobe.hlx.live/reviews-api/ ade0164.d41.co/ adobe.tt.omtrdc.net adobedc.demdex.net/ adobeioruntime.net adobesearch.adobe.io analytics.tiktok.com api.company-target.com/api/v2/ api.iperceptions.com bat.bing.com/ c.go-mpulse.net cdn.cookielaw.org dc-api.adobe.io dpm.demdex.net/ geolocation.onetrust.com/ lasteventf-tm.everesttech.net p13n.adobe.io/ pdfnow.adobe.io privacyportal.onetrust.com tr.snapchat.com/ main--dc--adobecom.hlx.page main--milo--adobecom.hlx.page main--dc--adobecom.hlx.live cdn.linkedin.oribi.io ;  default-src 'self' acrobat.adobe.com auth.services.adobe.com documentcloud.adobe.com acrobat.adobe.com ;  font-src 'self' use.typekit.net ;  form-action *.adobelogin.com *.snapchat.com/ helpx.adobe.com www.adobe.com www.facebook.com/tr/ ;  frame-src 'self' data: blob: *.amazonaws.com *.blob.core.windows.net 9212252.fls.doubleclick.net accounts.google.com acrobat.adobe.com adobe.demdex.net bid.g.doubleclick.net dc-api.adobecontent.io documentcloud.adobe.com acrobat.adobe.com servedby.flashtalking.com tr.snapchat.com/ tr6.snapchat.com/ universal.iperceptions.com video.tv.adobe.com vimeo.com www.facebook.com www.youtube.com ;  img-src 'self' about: blob: data: *.clarity.ms *.services.adobe.com alb.reddit.com/rp.gif analytics.twitter.com/ bat.bing.com/action/ c.clicktale.net/ cc-prod.scene7.com/ cdn.cookielaw.org cm.everesttech.net/cm/ cx.atdmt.com dpm.demdex.net googleads.g.doubleclick.net/pagead/ googleads.g.doubleclick.net/pagead/viewthroughconversion/ id.rlcdn.com/ match.prod.bidr.io/cookie-sync/ match.prod.bird.io/cookie-sync/ p.adsymptotic.com/d/px/ pt.ispot.tv/ px.ads.linkedin.com segments.company-target.com so.rlcdn.com/ t.co/i/ www.adobe.com www.facebook.com/ www.facebook.com/tr/ www.google.ch/pagead/ www.google.co.in/pagead/ www.google.co.jp/pagead/ www.google.com.au/pagead/ www.google.com/pagead/ www.google.ie/pagead/1p-user-list/ www.googletagmanager.com/ www.linkedin.com main--dc--adobecom.hlx.page main--milo--adobecom.hlx.page a5.behance.net www.googletagmanager.com milo.adobe.com p.typekit.net s.tgm.yahoo-net.jp ;  manifest-src 'self' ;  script-src 'self' 'unsafe-eval' *.adobe.com *.clarity.ms accounts.google.com/gsi/client ade0164.d41.co/sync/ adobe.demdex.net/ adobe.tt.omtrdc.net adobedc.demdex.net/ adobeioruntime.net/api/ analytics.tiktok.com/ analytics.twitter.com api.company-target.com/api/v2/ api.demandbase.com/api/ api.iperceptions.com assets.adobedtm.com bat.bing.com bid.g.doubleclick.net cdn.cookielaw.org/scripttemplates/ cdn.pdst.fm cdnssl.clicktale.net/ cm.everesttech.net connect.facebook.net cx.atdmt.com dpm.demdex.net ecf.d41.co/ geolocation.onetrust.com googleads.g.doubleclick.net googleads.g.doubleclick.net/pagead/viewthroughconversion/ lasteventf-tm.everesttech.net match.prod.bidr.io/cookie-sync/ munchkin.marketo.net/ p.adsymptotic.com/d/px pixel.everesttech.net/rlsa/ px.ads.linkedin.com rs.gwallet.com s.go-mpulse.net/ s2.go-mpulse.net sc-static.net/ scripts.demandbase.com sd.iperceptions.com segments.company-target.com servedby.flashtalking.com snap.licdn.com so.rlcdn.com/ static.ads-twitter.com t.co/i tag.clrstm.com tr.snapchat.com/ universal.iperceptions.com use.typekit.net www.everestjs.net/static/le/ www.facebook.com www.google.com www.googleadservices.com/pagead/ www.googletagmanager.com/ www.linkedin.com/px www.redditstatic.com/ads/pixel.js cdn.megadata.co.kr tk.mediacategory.com t1.daumcdn.net bc.ad.daum.net cdn.taboola.com pips.taboola.com trc.taboola.com js.adsrvr.org main--milo--adobecom.hlx.page tag.demandbase.com *.typekit.net ;  style-src 'self' 'unsafe-inline' *.adobe.com accounts.google.com/gsi/style adobeccstatic.com use.typekit.net main--milo--adobecom.hlx.page p.typekit.net ;  prefetch-src 'self' documentcloud.adobe.com acrobat.adobe.com blob: ;  worker-src 'self' blob: cdnssl.clicktale.net www.adobe.com/ ;"
    );
  });

  test.each`
    hostname
    ${'www.stage.adobe.com'}
    ${'main--dc--adobecom.hlx.page'}
    ${'main--dc--adobecom.hlx.live'}
    ${'stage--dc--adobecom.hlx.page'}
  `('ContentSecurityPolicy for stage', async ({ hostname }) => {
    window.location = new URL(`https://${hostname}/acrobat/online/test`);
    await ContentSecurityPolicy();
    const meta = document.querySelector('head meta');
    expect(meta.hasAttribute('http-equiv')).toBe(true);
    expect(meta.hasAttribute('content')).toBe(true);
    expect(meta.getAttribute('http-equiv')).toBe('Content-Security-Policy');
    expect(meta.getAttribute('content')).toBe(
      "connect-src 'self' blob: 14257-chimera-stage.adobeioruntime.net *.adobe.com *.adobe.io *.adobelogin.com *.amazonaws.com *.blob.core.windows.net *.clicktale.net/ *.mktoresp.com accounts.google.com/gsi/log accounts.google.com/gsi/status acom-reviews--adobe.hlx.live/reviews-api/ ade0164.d41.co/ adobe.tt.omtrdc.net adobedc.demdex.net/ adobeioruntime.net adobesearch-stage.adobe.io analytics.tiktok.com api.company-target.com/api/v2/ api.iperceptions.com bat.bing.com/ c.go-mpulse.net cchome.adobe.io/ cdn.cookielaw.org dc-api-stage.adobe.io dc.stage.acrobat.com dpm.demdex.net/ geolocation.onetrust.com/ lasteventf-tm.everesttech.net p13n-stage.adobe.io/fg/api/ p13n.adobe.io/ pdfnow-stage.adobe.io privacyportal.geolocation.onetrust.com/rust.com privacyportal.onetrust.com siteintercept.qualtrics.com/ tr.snapchat.com/ *.typekit.net main--dc--adobecom.hlx.page main--milo--adobecom.hlx.page main--dc--adobecom.hlx.live http://localhost:6456/ *.hlx.page cdn.linkedin.oribi.io ;  default-src 'self' auth-stg1.services.adobe.com dc.stage.acrobat.com stage.acrobat.adobe.com ;  font-src 'self' use.typekit.net ;  form-action *.adobelogin.com *.snapchat.com/ helpx.adobe.com survey.adobe.com/ www.adobe.com www.facebook.com/tr/ www.stage.adobe.com ;  frame-src 'self' data: blob: *.amazonaws.com *.blob.core.windows.net *.snapchat.com/ 9212252.fls.doubleclick.net accounts.google.com adobe.demdex.net bid.g.doubleclick.net dc-api-stage.adobecontent.io dc-api.adobecontent.io dc.stage.acrobat.com servedby.flashtalking.com stage.acrobat.adobe.com universal.iperceptions.com video.tv.adobe.com vimeo.com www.facebook.com www.youtube.com ;  img-src 'self' about: blob: data: *.adobe.com *.clarity.ms *.services.adobe.com alb.reddit.com/rp.gif s.tgm.yahoo-net.jp analytics.twitter.com/ bat.bing.com/action/ c.clicktale.net cc-prod.scene7.com/ cdn.cookielaw.org cm.everesttech.net/cm/ cx.atdmt.com dpm.demdex.net googleads.g.doubleclick.net/pagead/ id.rlcdn.com/ match.prod.bidr.io/cookie-sync/ match.prod.bidr.io/cookie-sync/demandbase/ match.prod.bird.io/cookie-sync/ p.adsymptotic.com/d/px/ pt.ispot.tv/ px.ads.linkedin.com segments.company-target.com t.co/i/ www.facebook.com/ www.facebook.com/tr/ www.google.ch/pagead/ www.google.co.in/pagead/ www.google.co.jp/pagead/ www.google.com.au/pagead/ www.google.com/pagead/ www.google.ie/pagead/1p-user-list/ www.googletagmanager.com/ www.linkedin.com milo.adobe.com main--dc--adobecom.hlx.page main--milo--adobecom.hlx.page a5.behance.net http://localhost:6456/ *.hlx.page ;  manifest-src 'self' ;  script-src 'self' 'unsafe-eval' *.adobe.com *.clarity.ms accounts.google.com/gsi/client ade0164.d41.co/sync/ adobe.demdex.net adobe.tt.omtrdc.net adobedc.demdex.net/ adobeioruntime.net/api adobeioruntime.net/api/ analytics.tiktok.com/ analytics.twitter.com api.company-target.com/api/v2/ api.demandbase.com/api/ api.iperceptions.com assets.adobedtm.com bat.bing.com bid.g.doubleclick.net cdn.cookielaw.org/scripttemplates/ cdn.pdst.fm cdnssl.clicktale.net/ cm.everesttech.net connect.facebook.net cx.atdmt.com dc.stage.acrobat.com dpm.demdex.net geolocation.onetrust.com googleads.g.doubleclick.net googleads.g.doubleclick.net/pagead/viewthroughconversion/ lasteventf-tm.everesttech.net local-test.acrobat.com:* match.prod.bidr.io/cookie-sync/ p.adsymptotic.com/d/px pixel.everesttech.net/rlsa/ px.ads.linkedin.com rs.gwallet.com s.go-mpulse.net s2.go-mpulse.net sc-static.net/ scripts.demandbase.com sd.iperceptions.com segments.company-target.com servedby.flashtalking.com siteintercept.qualtrics.com/ snap.licdn.com snap.licdn.com/li.lms-analytics snap.licdn.com/li.lms-analytics/ so.rlcdn.com/ stage.adobeccstatic.com static.ads-twitter.com t.co/i tag.clrstm.com tr.snapchat.com/ universal.iperceptions.com use.typekit.net www.everestjs.net/static/le/ www.facebook.com www.google.com www.googletagmanager.com www.googleadservices.com/pagead www.googletagmanager.com/gtag/ www.linkedin.com/px www.redditstatic.com/ads/pixel.js zn3n5vyia1vy8b4ly-adobe.siteintercept.qualtrics.com/ tag.demandbase.com munchkin.marketo.net cdn.megadata.co.kr tk.mediacategory.com t1.daumcdn.net bc.ad.daum.net cdn.taboola.com pips.taboola.com trc.taboola.com js.adsrvr.org main--milo--adobecom.hlx.page http://localhost:6456/ *.hlx.page ;  style-src 'self' 'unsafe-inline' *.adobe.com accounts.google.com/gsi/style dc.stage.acrobat.com stage.adobeccstatic.com use.typekit.net p.typekit.net main--milo--adobecom.hlx.page http://localhost:6456/ *.hlx.page ;  prefetch-src 'self' documentcloud.adobe.com acrobat.adobe.com blob: ;  worker-src 'self' blob: cdnssl.clicktale.net ;"
    );
  });

  test('ContentSecurityPolicy for localhost', async () => {
    window.location = new URL('https://localhost:2000/acrobat/online/test');
    await ContentSecurityPolicy();
    const meta = document.querySelector('head meta');
    expect(meta.hasAttribute('http-equiv')).toBe(true);
    expect(meta.hasAttribute('content')).toBe(true);
    expect(meta.getAttribute('http-equiv')).toBe('Content-Security-Policy');
    expect(meta.getAttribute('content')).toBe(
      "connect-src 'self' blob: 14257-chimera-stage.adobeioruntime.net *.adobe.com *.adobe.io *.adobelogin.com *.amazonaws.com *.blob.core.windows.net *.clarity.ms *.clicktale.net/ *.mktoresp.com accounts.google.com/gsi/log accounts.google.com/gsi/status adobe.tt.omtrdc.net adobeioruntime.net analytics.tiktok.com api.company-target.com/api/v2/ api.iperceptions.com c.go-mpulse.net cdn.cookielaw.org dc-api-dev.adobe.io dc.dev.dexilab.acrobat.com dpm.demdex.net geolocation.onetrust.com lasteventf-tm.everesttech.net p13n-stage.adobe.io/fg/api/ pdfnow-dev.adobe.io privacyportal.onetrust.com tr.snapchat.com/ cdn.megadata.co.kr tk.mediacategory.com t1.daumcdn.net bc.ad.daum.net cdn.taboola.com pips.taboola.com trc.taboola.com js.adsrvr.org main--milo--adobecom.hlx.page main--dc--adobecom.hlx.page main--dc--adobecom.hlx.live http://localhost:6456/ main--milo--adobecom.hlx.live fast-track--milo--adobecom.hlx.page fast-track--milo--adobecom.hlx.live *.typekit.net *.hlx.page cdn.linkedin.oribi.io ;  default-src 'self' auth-stg1.services.adobe.com ;  font-src 'self' use.typekit.net ;  form-action *.snapchat.com *.adobelogin.com helpx.adobe.com www.facebook.com/tr/ ;  frame-src 'self' data: blob: *.amazonaws.com *.blob.core.windows.net 9212252.fls.doubleclick.net accounts.google.com adobe.demdex.net bid.g.doubleclick.net dc-api-dev.adobecontent.io dc.dev.dexilab.acrobat.com dev.acrobat.adobe.com servedby.flashtalking.com tr.snapchat.com/ tr6.snapchat.com/ universal.iperceptions.com video.tv.adobe.com vimeo.com www.facebook.com www.youtube.com ;  img-src 'self' about: blob: data: *.clarity.ms *.services.adobe.com alb.reddit.com/rp.gif bat.bing.com/action/ cdn.cookielaw.org cm.everesttech.net/cm/ dpm.demdex.net googleads.g.doubleclick.net/pagead/ id.rlcdn.com/ match.prod.bidr.io/ match.prod.bidr.io/cookie-sync/demandbase/ match.prod.bird.io/cookie-sync/ p.adsymptotic.com/d/px/ pt.ispot.tv/ px.ads.linkedin.com segments.company-target.com t.co/i/ www.adobe.com www.dev01.adobe.com www.facebook.com/tr/ www.google.ch/pagead/ www.google.co.in/pagead/ www.google.co.jp/pagead/ www.google.com.au/pagead/ www.google.com/pagead/ www.google.ie/pagead/ www.linkedin.com www.facebook.com s.tgm.yahoo-net.jp main--dc--adobecom.hlx.page main--acrobat--adobecom.hlx.page main--milo--adobecom.hlx.page http://localhost:6456/ main--milo--adobecom.hlx.live fast-track--milo--adobecom.hlx.page fast-track--milo--adobecom.hlx.live *.hlx.page ;  manifest-src 'self' ;  script-src 'self' 'unsafe-eval' *.adobe.com *.clarity.ms accounts.google.com/gsi/client adobe.demdex.net adobe.tt.omtrdc.net analytics.tiktok.com/ analytics.twitter.com assets.adobedtm.com bat.bing.com bid.g.doubleclick.net cdn.cookielaw.org/ cdn.pdst.fm cdnssl.clicktale.net/ connect.facebook.net dc.dev.dexilab.acrobat.com geolocation.onetrust.com googleads.g.doubleclick.net/pagead/viewthroughconversion/ local-test.acrobat.com:* pixel.everesttech.net/ s2.go-mpulse.net sc-static.net/ scripts.demandbase.com sd.iperceptions.com servedby.flashtalking.com snap.licdn.com/li.lms-analytics/ so.rlcdn.com/ static.ads-twitter.com universal.iperceptions.com use.typekit.net www.everestjs.net/static/le/ www.facebook.com www.google.com www.googleadservices.com/pagead/ www.googletagmanager.com/gtag/ www.redditstatic.com/ads/pixel.js main--milo--adobecom.hlx.page stage.adobeccstatic.com http://localhost:6456/ main--milo--adobecom.hlx.live fast-track--milo--adobecom.hlx.page fast-track--milo--adobecom.hlx.live api.demandbase.com *.hlx.page ;  style-src 'self' 'unsafe-inline' main--milo--adobecom.hlx.page *.adobe.com accounts.google.com/gsi/style dc.dev.dexilab.acrobat.com use.typekit.net p.typekit.net stage.adobeccstatic.com p.typekit.net http://localhost:6456/ *.hlx.page ;  prefetch-src 'self' documentcloud.adobe.com acrobat.adobe.com blob: ;  worker-src 'self' cdnssl.clicktale.net blob: ;"
    );
  });
});
